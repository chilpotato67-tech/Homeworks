Vagrant.configure("2") do |config|

  # ================= JENKINS MASTER =================
  config.vm.define "jenkins-master" do |master|
    master.vm.box = "ubuntu/jammy64"
    master.vm.hostname = "jenkins-master"
    master.vm.network "private_network", ip: "192.168.56.10"

    master.vm.provider "virtualbox" do |vb|
      vb.memory = 4096
      vb.cpus  = 3
    end

    master.vm.provision "shell", inline: <<-SHELL
      set -eux

      # ---- Base packages ----
      sudo apt update
      sudo apt install -y \
        ca-certificates \
        curl \
        gnupg \
        lsb-release \
        openjdk-17-jdk \
        docker.io \
        git

      # ---- Docker ----
      sudo systemctl enable docker
      sudo systemctl start docker
      sudo usermod -aG docker vagrant

      # ---- Jenkins GPG key (CORRECT & FINAL) ----
      sudo mkdir -p /usr/share/keyrings

      curl -fsSL https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key \
        | sudo gpg --dearmor -o /usr/share/keyrings/jenkins-keyring.gpg

      sudo chmod 644 /usr/share/keyrings/jenkins-keyring.gpg

      echo "deb [signed-by=/usr/share/keyrings/jenkins-keyring.gpg] https://pkg.jenkins.io/debian-stable binary/" \
        | sudo tee /etc/apt/sources.list.d/jenkins.list > /dev/null

      # ---- Jenkins install ----
      sudo apt update
      sudo apt install -y jenkins

      sudo systemctl enable jenkins
      sudo systemctl start jenkins
    SHELL
  end

  # ================= JENKINS WORKER =================
  config.vm.define "jenkins-worker" do |worker|
    worker.vm.box = "ubuntu/jammy64"
    worker.vm.hostname = "jenkins-worker"
    worker.vm.network "private_network", ip: "192.168.56.11"

    worker.vm.provider "virtualbox" do |vb|
      vb.memory = 4096
      vb.cpus  = 3
    end

    worker.vm.provision "shell", inline: <<-SHELL
      set -eux

      sudo apt update
      sudo apt install -y \
        ca-certificates \
        curl \
        openjdk-17-jdk \
        docker.io \
        git

      sudo systemctl enable docker
      sudo systemctl start docker
      sudo usermod -aG docker vagrant
    SHELL
  end

end
